<include file="Public:header" />
<style type="text/css"> table {font-size: 12px} </style>
<div class="pad-lr-10">
    <form name="searchform" id="searchform" action="admin.php?m={$controller}&a={$display}" method="get" >
        <table width="100%" cellspacing="0" class="search-form">
            <tbody>
            <tr>
                <td>
                    <div class="explain-col">
                        <span style="margin-left:12px;">年级 :</span>
                        <select name="grade_id" id="grade_id" onchange="getAllList()" style="width:160px;">
                            <option value="">请选择</option>
                            <volist name="grade_list" id="val">
                                <option value="{$val.id}" <if condition="$grade_id eq $val['id']">selected="selected"</if>>{$val.name}</option>
                            </volist>
                        </select>
                        <span style="margin-left:30px;">学科 :</span>
                        <select name="cate_id" id="cate_id" onchange="getAllList()" style="width:160px;">
                            <option value="">请选择</option>
                            <volist name="cate_list" id="val">
                                <option value="{$val.id}" <if condition="$cate_id eq $val['id']">selected="selected"</if>>{$val.name}</option>
                            </volist>
                        </select>
                        <span style="margin-left:30px;">测验类型 :</span>
                        <select name="style_id" id="style_id" style="width:160px;">
                            <option value="">请选择</option>
                            <volist name="style_list" id="val">
                                <option value="{$val.id}" <if condition="$style_id eq $val['id']">selected="selected"</if>>{$val.name}</option>
                            </volist>
                        </select>
                        <span style="margin-left:50px;">题目类型 :</span>
                        <select name="type_id" id="type_id" onclick="cateChecked()" style="width:160px;">
                            <option value="">请选择</option>
                            <volist name="type_list" id="val">
                                <option value="{$val.id}" <if condition="$type_id eq $val['id']">selected="selected"</if>>{$val.name}</option>
                            </volist>
                        </select>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="explain-col">
                        <span>知识点 :</span>
                        <select name="point_id" id="point_id" onclick="isChecked()" style="width:160px;">
                            <option value="">请选择</option>
                            <volist name="point_list" id="val">
                                <option value="{$val.id}" <if condition="$point_id eq $val['id']">selected="selected"</if>>{$val.name}</option>
                            </volist>
                        </select>
                        <span style="margin-left:42px;">章 :</span>
                        <select name="chapter_id" id="chapter_id" onclick="isChecked()" style="width:160px;">
                            <option value="">请选择</option>
                            <volist name="chapter_list" id="val">
                                <option value="{$val.id}" <if condition="$chapter_id eq $val['id']">selected="selected"</if>>{$val.alias}.&nbsp;{$val.name}</option>
                            </volist>
                        </select>
                        <span style="margin-left:66px;">节 :</span>
                        <select name="section_id" id="section_id" onclick="chapterChecked()" style="width:160px;">
                            <option value="">请选择</option>
                            <volist name="section_list" id="val">
                                <option value="{$val.id}" <if condition="$section_id eq $val['id']">selected="selected"</if>>{$val.alias}.&nbsp;{$val.name}</option>
                            </volist>
                        </select>
                        <span style="margin-left:60px;"></span>
                        <input type="hidden" name="m" value="{$controller}" />
                        <input type="hidden" name="a" value="{$display}" />
                        <input type="submit" name="search" class="button" value="搜索" />
                        <span style="margin-left:20px;"></span>
                        <input type="button" class="button" value="重置" onclick="clean()"/>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </form>
    <form id="myform" name="myform" action="admin.php?m={$controller}&a=deleteQuestion" method="post" onsubmit="return checkQuestion();">
        <div class="table-list">
            <table width="100%" cellspacing="0">
                <thead>
                <tr>
                    <th width=50>ID</th>
                    <th width=30><input type="checkbox" value="" id="check_box" onclick="selectall('id[]');"></th>
                    <th>题干</th>
                    <!--<th width=60>年级</th>
                    <th width=60>学科</th>-->
                    <th width=90>知识点</th>
                    <th width=90>章</th>
                    <th width=90>节</th>
                    <th width=80>测验类型</th>
                    <th width=80>题目类型</th>
                    <th width=30>排序</th>
                    <th width=30>状态</th>
                    <th width=60>是否收藏</th>
                    <th width=60>是否下载</th>
                    <th width=100>操作</th>
                </tr>
                </thead>
                <tbody>
                <volist name="question_list" id="val" key="k" >
                    <tr>
                        <td align="center">{$val.id}</td>
                        <td align="center"><input type="checkbox" value="{$val.id}" name="id[]"></td>
                        <td align="center">{$val.title}</td>
                        <!--<td align="center">{$val.grade}</td>
                        <td align="center">{$val.cate}</td>-->
                        <td align="center">{$val.point}</td>
                        <td align="center">{$val.chapter}</td>
                        <td align="center">{$val.section}</td>
                        <td align="center">{$val.style}</td>
                        <td align="center">{$val.type}</td>
                        <td align="center">
                            <input type="text" class="input-text-c input-text" onblur="sortQuestion({$val.id},'sort',this.value)" id="sort_{$val.id}" value="{$val.sort}" size="4" name="listorders[{$val.id}]">
                        </td>
                        <td align="center" onclick="statusQuestion({$val.id},'status')" id="status_{$val.id}"><img src="__ROOT__/statics/images/status_{$val.status}.gif" /></td>
                        <td align="center">
                            <if condition="$val['is_collect'] eq 1">
                                <span style="color:#009933;">已收藏</span>
                            <else/>
                                未收藏
                            </if>
                        </td>
                        <td align="center">
                            <if condition="$val['is_download'] eq 1">
                                <span style="color:#009933;">已下载</span>
                                <else/>
                                未下载
                            </if>
                        </td>
                        <td align="center">
                            <a href="javascript:editQuestion({$val.id})" style="color:#0000FF;width:20px;">查看</a>
                            <a href="javascript:collectQuestion({$val.id})" style="color:#0000FF;width:20px;">收藏</a>
                            <a href="javascript:downloadQuestion({$val.id})" style="color:#0000FF;width:20px;">下载</a>
                        </td>
                    </tr>
                </volist>
                </tbody>
            </table>
            <div class="btn">
                <label for="check_box" style="float:left;">{$Think.lang.select_all}/{$Think.lang.cancel}</label>
                <input type="submit" class="button" name="dosubmit" value="{$Think.lang.delete}" onclick="return confirm('{$Think.lang.sure_delete}')" style="float:left;margin-left:10px;"/>
                <div id="pages">{$page}</div>
            </div>
        </div>
    </form>
</div>
<script language="javascript">
    $(function(){
        //从其他页面（如上传新题页面）跳转到此页面后，需要调用一下父窗口的_MP方法，才能保证样式和targetUrl是当前页面
        var controller = "{$controller}";
        var display = "{$display}";
        var menuid = 0;
        if(controller=='Ad'){
            menuid = 152;
        }else if(controller=='SellerList'){
            menuid = 141;
        }else if(controller=='Article'){
            menuid = 103;
        }
        var src = $("#rightMain",parent.document).attr('src');
        var targetUrl = '/admin.php?m='+controller+'&a='+display;
        if(src!=targetUrl){
            parent._MP(menuid,targetUrl);
        }
    });
    //重置
    function clean(){
        $("#grade_id").val('');
        $("#cate_id").val('');
        $("#style_id").val('');
        $("#type_id").val('');
        $("#point_id").val('');
        $("#chapter_id").val('');
        $("#section_id").val('');
        $("#searchform").submit();
    }
    //获取所有基于学段id和学科id的列表
    function getAllList(){
        getPointList();
        getChapterList();
        getTypeList();
    }
    //判断年级和学科有没有选择
    function isChecked(){
        var grade_id = $("#grade_id").val();
        var cate_id = $("#cate_id").val();
        if(grade_id == ""){
            alert("请先选择年级！");
            return false;
        }
        if(cate_id == ""){
            alert("请先选择学科！");
            return false;
        }
    }
    //只判断学科有没有选择
    function cateChecked(){
        var cate_id = $("#cate_id").val();
        if(cate_id == ""){
            alert("请先选择学科！");
            return false;
        }
    }
    //获取知识点列表
    function getPointList(){
        var grade_id = $("#grade_id").val();
        var cate_id = $("#cate_id").val();
        if(grade_id!='' && cate_id!=''){
            var url = "admin.php?m={$controller}&a=getPointList";
            $.get(url, { grade_id: grade_id, cate_id: cate_id }, function(jsondata){
                $("#point_id").find("option").remove();
                $("#point_id").append("<option value=''>请选择</option>");
                $.each(jsondata,function(idx,obj){
                    $("#point_id").append("<option value='"+obj.id+"'>"+obj.name+"</option>");
                });
            });
        }
    }
    //获取章列表
    function getChapterList(){
        var grade_id = $("#grade_id").val();
        var cate_id = $("#cate_id").val();
        if(grade_id!='' && cate_id!=''){
            var url = "admin.php?m={$controller}&a=getChapterList";
            $.get(url, { grade_id: grade_id, cate_id: cate_id }, function(jsondata){
                console.log(jsondata);
                $("#chapter_id").find("option").remove();
                $("#chapter_id").append("<option value=''>请选择</option>");
                $.each(jsondata,function(idx,obj){
                    $("#chapter_id").append("<option value='"+obj.id+"'>"+obj.alias+'. '+obj.name+"</option>");
                });

                //章未发生change事件时节列表的初始设置
                if($("#chapter_id").val() == jsondata[0].id){
                    $("#section_id").find("option").remove();
                    $("#section_id").append("<option value=''>请选择</option>");
                    $.each(jsondata[0].section,function(id,object){
                        $("#section_id").append("<option value='"+object.id+"'>"+object.alias+'. '+object.name+"</option>");
                    });
                }

                //设置章节列表联动(节随章动)
                $("#chapter_id").change(function(){
                    $("#section_id").find("option").remove();
                    $("#section_id").append("<option value=''>请选择</option>");
                    $.each(jsondata,function(idx,obj){
                        if($("#chapter_id").val() == obj.id){
                            $.each(obj.section,function(id,object){
                                $("#section_id").append("<option value='"+object.id+"'>"+object.alias+'. '+object.name+"</option>");
                            });
                        }
                    });
                });
            });
        }
    }
    //判断章有没有选择
    function chapterChecked(){
        var chapter_id = $('#chapter_id').val();
        if(chapter_id == ""){
            alert("请先选择章！");
            return false;
        }
    }
    //获取测验类型列表
    function getTypeList(){
        var cate_id = $("#cate_id").val();
        if(cate_id!=''){
            var url = "admin.php?m={$controller}&a=getTypeList";
            $.get(url, { cate_id: cate_id }, function(jsondata){
                $("#type_id").find("option").remove();
                $("#type_id").append("<option value=''>请选择</option>");
                $.each(jsondata,function(idx,obj){
                    $("#type_id").append("<option value='"+obj.id+"'>"+obj.name+"</option>");
                });
            });
        }
    }
    function checkQuestion(){
        var ids='';
        $("input[name='id[]']:checked").each(function(i, n){
            ids += $(n).val() + ',';
        });
        if(ids=='') {
            window.top.art.dialog({content:lang_please_select+'菜单分类名称	',lock:true,width:'200',height:'50',time:1.5},function(){});
            return false;
        }
        return true;
    }

    function statusQuestion(id,type){
        var url = "admin.php?m={$controller}&a=statusQuestion";
        $.get(url, { id: id, type: type }, function(jsondata){
            var return_data  = eval("("+jsondata+")");
            $("#"+type+"_"+id+" img").attr('src', '__ROOT__/statics/images/status_'+return_data+'.gif');
        });
    }
    //排序方法
    function sortQuestion(id,type,num){
        var url = "admin.php?m={$controller}&a=sortQuestion";
        $.get(url, { id: id, type: type,num:num }, function(jsondata){
            var return_data  = eval("("+jsondata+")");
            $("#"+type+"_"+id+" ").attr('value', return_data);
        });
    }
    //查看、编辑
    function editQuestion(id) {
        location.href = "admin.php?m={$controller}&a=editQuestion&id="+id;
    }
    //收藏
    function collectQuestion(id) {
        var url = "admin.php?m={$controller}&a=collectQuestion";
        $.get(url, { id: id }, function(jsondata){
            window.top.art.dialog({id:'collectQuestion',content:jsondata.info,lock:true,width:'200',height:'50',time:1});
            if(jsondata.status==1){
                window.location.reload();
            }
        });
    }
    //下载
    function downloadQuestion(id) {
        var url = "admin.php?m={$controller}&a=downloadQuestion";
        $.get(url, { id: id }, function(jsondata){
            if(jsondata.status==2){
                //已下载过，是否要重新下载
                window.top.art.dialog({id:'downloadAsk'}).close();
                window.top.art.dialog(
                        {
                            title:'提示',
                            id:'downloadAsk',
                            iframe:'?m={$controller}&a=downloadAsk&id='+id,
                            width:'360',
                            height:'50'
                        },
                        function(){
                            var d = window.top.art.dialog({id:'downloadAsk'}).data.iframe;
                            d.document.getElementById('dosubmit').click();
                            return false;
                        },
                        function(){
                            window.top.art.dialog({id:'downloadAsk'}).close()
                        }
                );
//                if(confirm(jsondata.info)){
//                    $.get("admin.php?m={$controller}&a=downloadDirect", { id: id }, function(data){
//                        alert(data.info);
//                    });
//                }
            }else{
                window.top.art.dialog({content:jsondata.info,lock:true,width:'200',height:'50',time:1});
                if(jsondata.status==1){
                    window.location.reload();
                }
            }
        });
    }
</script>
</body>
</html>